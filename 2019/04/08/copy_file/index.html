<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>How to copy files fastly | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="First let’s generate a dummy file for test. We can do it with the following cmd superly fast.1fallocate -l 2G copy_test.img 1234567891011121314151617181920212223242526272829303132333435363738394041424">
<meta property="og:type" content="article">
<meta property="og:title" content="How to copy files fastly">
<meta property="og:url" content="http://yoursite.com/2019/04/08/copy_file/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="First let’s generate a dummy file for test. We can do it with the following cmd superly fast.1fallocate -l 2G copy_test.img 1234567891011121314151617181920212223242526272829303132333435363738394041424">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-04-08T00:09:03.662Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How to copy files fastly">
<meta name="twitter:description" content="First let’s generate a dummy file for test. We can do it with the following cmd superly fast.1fallocate -l 2G copy_test.img 1234567891011121314151617181920212223242526272829303132333435363738394041424">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-copy_file" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/08/copy_file/" class="article-date">
  <time datetime="2019-04-08T00:09:03.662Z" itemprop="datePublished">2019-04-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      How to copy files fastly
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>First let’s generate a dummy file for test. We can do it with the following cmd superly fast.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fallocate -l 2G copy_test.img</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        File source = <span class="keyword">new</span> File(<span class="string">"/home/benson/develop/test/copy_test.img"</span>);</span><br><span class="line">        File target1 = <span class="keyword">new</span> File(<span class="string">"/home/benson/develop/test/target1.img"</span>);</span><br><span class="line">        File target2 = <span class="keyword">new</span> File(<span class="string">"/home/benson/develop/test/target2.img"</span>);</span><br><span class="line">        File target3 = <span class="keyword">new</span> File(<span class="string">"/home/benson/develop/test/target3.img"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Source file is of size: "</span> + source.length());</span><br><span class="line">        <span class="keyword">long</span> pre = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">long</span> now = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span>(FileInputStream fin = <span class="keyword">new</span> FileInputStream(source); FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(target1)) &#123;</span><br><span class="line">            fin.getChannel().transferTo(<span class="number">0</span>, source.length(), fout.getChannel());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        now = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"NIO tranfer takes: "</span> + (now - pre));</span><br><span class="line">        pre = now;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.copy(source.toPath(), target2.toPath());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        now = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"Files.copy takes: "</span> + (now - pre));</span><br><span class="line">        pre = now;</span><br><span class="line">        <span class="keyword">try</span> (BufferedInputStream bin = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(source));</span><br><span class="line">             BufferedOutputStream bout = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(target3));) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span>];</span><br><span class="line">            <span class="keyword">int</span> count = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> ((count = bin.read(bs)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bout.write(bs, <span class="number">0</span>, count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        now = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"BufferedInputStream takes: "</span> + (now - pre));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Source file is of size: 2147483648</span><br><span class="line">NIO tranfer takes: 893</span><br><span class="line">Files.copy takes: 3087</span><br><span class="line">BufferedInputStream takes: 13113</span><br></pre></td></tr></table></figure></p>
<p>NIO <code>FileChannel::transfer</code> has the best performance. It utilizes direct ByteBuffer, which directly operates the file data in OS’s kernal space. While <code>Files::copy</code> and BufferedInputStream has to transfer data from kernal space and vise versa.</p>
<p>I planned to also test for <code>MappedByteBuffer</code>, but it doesn’t support to map more than 2 GB(precisely 2^31-1 bytes) data into memory directly. So I give it up. But basically, I guess it would have the same performace as <code>FileChannel::transferTo</code>.</p>
<p><em>But currently I don’t have a clue why BufferedInputStream is way worse than Files.copy. Let’s explore it later.</em></p>
<p>Please not that direct buffer is allocated outside of Java heap space. And it’s only cleaned at Full GC. So we have to use it carefully to avoid OOM. To adjust max direct memory size, we can use<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:MaxDirectMemorySize=512M</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/04/08/copy_file/" data-id="cju7lic030006siqa0d216amo" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/04/08/gaaccess/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Using GoAccess to monitor your nginx access log
        
      </div>
    </a>
  
  
    <a href="/2019/04/08/create-your-own-blog/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Create blog with Hexo on Git Page</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/04/08/tmux/">Use tmux to manage your remote server</a>
          </li>
        
          <li>
            <a href="/2019/04/08/setup_nginx_for_msa_development/">Setup Nginx for MSA Development</a>
          </li>
        
          <li>
            <a href="/2019/04/08/jvm_monitor/">Monitor JVM Process Remotely</a>
          </li>
        
          <li>
            <a href="/2019/04/08/import_spring_framework_source/">Import spring-framework into Eclipse</a>
          </li>
        
          <li>
            <a href="/2019/04/08/gaaccess/">Using GoAccess to monitor your nginx access log</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>